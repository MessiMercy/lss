
<!-- TOC -->

- [1、概念](#1概念)
- [2、原理](#2原理)
    - [1、查找](#1查找)
    - [2、插入](#2插入)
    - [3、删除](#3删除)
- [3、跳表有多快？](#3跳表有多快)
- [4、跳表有多占内存？](#4跳表有多占内存)
- [5、跳表实现（ConcurrentSkipListSet和ConcurrentSkipListMap）](#5跳表实现concurrentskiplistset和concurrentskiplistmap)
- [99、问题](#99问题)
- [1、为啥 redis 使用跳表(skiplist)而不是使用 red-black？](#1为啥-redis-使用跳表skiplist而不是使用-red-black)
- [参考](#参考)

<!-- /TOC -->

# 1、概念

如果是有序链表，真的就没有办法使用二分查找算法了吗？实际上对有序链表稍加改造，我们就可以对链表进行二分查找。这就是跳表。


skiplist是一种基于有序链表的扩展，简称跳表。跳表有着更为简单的实现和不容小觑的操作复杂度（均摊O(logN)）,跳表是一种概率性替代平衡树的数据结构，并且不需要平衡和储存优先级信息。


SkipList(跳表)这种数据结构是由William Pugh于1990年发表Skip lists: a probabilistic alternative to balanced trees。由论文标题可知，SkipList的设计初衷是作为替换平衡树的一种选择。

我们都知道，AVL树有着严格的O(logN)的查询效率，但是由于插入过程中可能需要多次旋转，导致插入效率较低，因而才有了在工程界更加实用的红黑树。

但是红黑树有一个问题就是在并发环境下使用不方便，比如需要更新数据时，Skip需要更新的部分比较少，锁的东西也更少，而红黑树有个平衡的过程，在这个过程中会涉及到较多的节点，需要锁住更多的节点，从而降低了并发性能。SkipList还有一个优势就是实现简单。

时隔将近三十多年，SkipList这种数据结构仍在许多途径有用武之地，比如Redis, 还有Google的著名项目Bigtable.



![](../../pic/2020-05-05-11-33-56.png)

我们可以发现从a->b->c->d->e，其实就是不断地在一条链表的某个节点上拉出新的转移链，而跳表的本体（裸体）a，也是构造好的跳表的最下层，就是一条经过排序的链表。


比如我们来模拟一下查找25这个数的过程：

![](../../pic/2020-05-05-11-38-02.png)

由此可见，建立的转移链越多，查找某个元素的转移次数也就越少（可以快速跨越其中很长一段序列），这是一种典型的“以空间换取时间”的做法。这样做一方面避免了链表查找的缓慢（普通链表查找需要用O(N)遍历一遍），另一方面又保存的链表良好的特性（O(1)的插入和删除），简直一颗赛艇。

这种带多级索引的链表，就是跳表。是不是很像数据库中的索引？





# 2、原理

其实跳表就是在有序单向链表的基础上增加了一些索引，而且这些索引是分层的，从而可以快速地查的到数据。如下是一个典型的跳表:

![](../../pic/2020-05-05-11-23-26.png)




## 1、查找

查找示意图如下:

![](../../pic/2020-05-05-11-24-24.png)

比如我们要查找key为19的结点，那么我们不需要逐个遍历，而是按照如下步骤:

- 1、从header出发，从高到低的level进行查找，先索引到9这个结点，发现9 < 19,继续查找(然后在level==2这层)，查找到21这个节点，由于21 > 19, 所以结点不往前走，而是level由2降低到1

- 2、然后索引到17这个节点，由于17 < 19, 所以继续往后，索引到21这个结点，发现21>19, 所以level由1降低到0

- 3、在结点17上，level==0索引到19,查找完毕。

- 4、如果在level==0这层没有查找到，那么说明不存在key为19的节点，查找失败



## 2、插入

如下是插入结点示意图:

![](../../pic/2020-05-05-11-28-08.png)

其实插入节点的关键就是找到合适的插入位置，即从所有小于待插入节点key值的节点中，找出最大的那个，所以插入节点的过程如下:

- 查找合适的插入位置，比如上图中要插入key为17的结点，就需要一路查找到12,由于12 < 17,而12的下一个结点19 > 17,因而满足条件

- 创建新结点，并且产生一个在1~MAX_LEVEL之间的随机level值作为该结点的level

- 调整指针指向



## 3、删除

移除结点的示意图如下:

![](../../pic/2020-05-05-11-28-59.png)

移除结点其实很简单,就分以下3步:

- 查找到指定的结点，如果没找到则返回
- 调整指针指向
- 释放结点空间


# 3、跳表有多快？

单链表的查找一个元素的时间复杂度为O(n)，那么跳表的时间复杂度是多少？

假如链表中有 n 个元素，我们每两个节点建立一个索引，那么第 1 级索引的结点个数就是 n/2 ，第二级就是 n/4，第三级就是 n/8, 依次类推，也就是说第 k 级索引的结点个数是第 k-1 级索引的结点个数的 1/2，那么第k级索引的节点个数为 n 除以 2 的 k 次方，即 n/(2^k)。

假设索引有 h 级，最高级的索引有 2 个结点。通过上面的公式，我们可以得到 n/(2^h) = 2，得到 h=log2n - 1，包含原始链表这一层的话，跳表的高度就是 log2n，假设每层需要访问 m 个结点，那么总的时间复杂度就是O(m*log2n)。而每层需要访问的 m 个结点，m 的最大值不超过 3，这里为什么是 3 ，可以自己试着走一个。

![](../../pic/2020-05-05-11-52-47.png)

因此跳表的时间复杂度为O(3log2n) = O(log2n)



# 4、跳表有多占内存？

天下没有免费的午餐，时间复杂度能做到 O(logn) 是以建立在多级索引的基础之上，这会导致内存占用增加，那么跳表的空间复杂度是多少呢？

假如有 n 个元素的链表，第一级索引为 n/2 个，第二级为 n/4 个，第三级为 n/8 个，......，最后一级为 2 个。这几级索引的结点总和就是n/2+n/4+n/8…+8+4+2=n-2。所以，跳表的空间复杂度是 O(n)。也就是说，如果将包含 n 个结点的单链表构造成跳表，我们需要额外再用接近 n 个结点的存储空间。那我们有没有办法降低索引占用的内存空间呢？

假如每 3 个节点抽取一个作为索引，同样的方法，可以计算出空间复杂度为 O(n/2) ,已经节约一半的存储空间了。

实际上，在软件开发中，我们不必太在意索引占用的额外空间。在讲数据结构和算法时，我们习惯性地把要处理的数据看成整数，但是在实际的软件开发中，原始链表中存储的有可能是很大的对象，而索引结点只需要存储几个指针，并不需要存储对象，所以当对象比索引结点大很多时，那索引占用的额外空间就可以忽略了。



# 5、跳表实现（ConcurrentSkipListSet和ConcurrentSkipListMap）

跳表应支持的功能： 
- 1、插入一个元素 
- 2、删除一个元素 
- 3、查找一个元素 
- 4、查找一个区间的元素 
- 5、输出有序序列


> 1、有序的情况

- 1、在非多线程的情况下，应当尽量使用TreeMap（红黑树实现）。 
- 2、对于并发性相对较低的并行程序可以使用Collections.synchronizedSortedMap将TreeMap进行包装，也可以提供较好的效率。
- 3、但是对于高并发程序，应当使用ConcurrentSkipListMap。

 
> 2、无序情况下

- 1、并发程度低，数据量大时，ConcurrentHashMap 存取远大于ConcurrentSkipListMap。 
- 2、数据量一定，并发程度高时，ConcurrentSkipListMap比ConcurrentHashMap效率更高。


# 99、问题

# 1、为啥 redis 使用跳表(skiplist)而不是使用 red-black？

https://www.zhihu.com/question/20202931/answer/16086538


- 1 skiplist的复杂度和红黑树一样，而且实现起来更简单。

- 2 在并发环境下skiplist有另外一个优势，红黑树在插入和删除的时候可能需要做一些rebalance的操作，这样的操作可能会涉及到整个树的其他部分，而skiplist的操作显然更加局部性一些，锁需要盯住的节点更少，因此在这样的情况下性能好一些。

- 3、红黑树在查找区间元素的效率没有跳表高，其他操作时间复杂度一致。bug 少，稳定，易读，易维护。 

- 4、跳表更加灵活，通过改变索引构建策略，有效平衡效率和内存消耗。





# 参考

- [漫画：什么是跳跃表？](https://mp.weixin.qq.com/s/COBdoHWDhlw4rmG_fGFhSA)

- [SkipList的原理与实现](https://zhuanlan.zhihu.com/p/33674267)

- [随机化（二）：跳表 (Skip lists)](https://zhuanlan.zhihu.com/p/21287572)

- [Skip lists: a probabilistic alternative to balanced trees](http://homepage.cs.uiowa.edu/~ghosh/skip.pdf)

- [跳表这种高效的数据结构，值得每一个程序员掌握](https://zhuanlan.zhihu.com/p/54869087)